name: test-and-publish

on:
  # run on all pushes to any branch
  push:
  # run only on master pull requests
  pull_request:
    branches: [master]
  # also run periodically

jobs:
  changelog:
    runs-on: ubuntu-latest
    name: Update CHANGELOG.md
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python ðŸ
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Install commitizen-cli
        run: |
          python -m pip install --upgrade pip
          pip install commitizen
      - name: Update changelog using commitizen
        run: cz changelog
      - name: Commit CHANGELOG.md
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add CHANGELOG.md
          git commit -m "docs(changelog): update changelog" || echo "no changes"
          git push || echo "nothing to push"

  # build-and-publish:
  #   runs-on: ubuntu-latest
  #   # Requires that unit tests pass but doesn't require lints
  #   needs: pytest-coverage
  #   name: Build and publish Python ðŸ distributions ðŸ“¦ to PyPI
  #   # Pushes to PyPI on tagged commit pushes of master branch
  #   # Additionally tests building with setuptools on all branches
  #   steps:
  #     - uses: actions/checkout@master
  #     - name: Set up Python 3.8
  #       uses: actions/setup-python@v1
  #       with:
  #         python-version: 3.8
  #     - name: Install invoke and nox
  #       run: >-
  #         python -m pip install invoke nox
  #     - name: Build binary wheel and a source tarball
  #       run: >-
  #         invoke build
  #     - name: Publish distribution ðŸ“¦ to PyPI on tagged commit pushes
  #       # Publish to PyPI on tagged commit pushes on master
  #       if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
  #       uses: pypa/gh-action-pypi-publish@master
  #       with:
  #         user: __token__
  #         password: ${{ secrets.PYPI_PASSWORD }}

  release:
    runs-on: ubuntu-latest
    # Requires tests and changelog make pass
    needs: [changelog]
    name: Release on GitHub
    steps:
      - name: Create incremental changelog
        run: |
          cat CHANGELOG.md | sed -n '1,/## v/p' | head --lines=-2 > RELEASE_CHANGELOG.md

      - name: Publish release on GitHub
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            RELEASE_CHANGELOG.md
          body_path: RELEASE_CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
